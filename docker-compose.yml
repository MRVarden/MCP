# ============================================
# LUNA CONSCIOUSNESS - DOCKER COMPOSE
# ============================================
# Version: 2.1.0-secure
# Auteur: Varden & Luna
# Date: 30 novembre 2025
# ============================================
# ARCHITECTURE SÉCURISÉE:
# - Tous les ports bindés sur 127.0.0.1 uniquement
# - Redis non exposé (réseau interne seulement)
# - Secrets externalisés dans .env
# - Réseaux isolés (172.28.x.x interne / 172.29.x.x externe)
# - Tous les containers en non-root
# - Security hardening complet (cap_drop, read_only, no-new-privileges)
# ============================================

services:
  # ============================================
  # LUNA CONSCIOUSNESS - Service Principal
  # ============================================
  luna-consciousness:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        LUNA_VERSION: 2.1.0-secure
    image: aragogix/luna-consciousness:v2.1.0-secure
    container_name: luna-consciousness
    restart: unless-stopped

    # SEC-004: Run as non-root user (UID 1000)
    user: "1000:1000"

    # Security hardening complet
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=100M
      - /app/logs:mode=1755,size=50M

    # SEC-005: Ports exposés UNIQUEMENT sur localhost
    ports:
      - "127.0.0.1:3000:3000"    # MCP Server SSE
      - "127.0.0.1:8000:8000"    # FastMCP default port
      - "127.0.0.1:8080:8080"    # API REST
      - "127.0.0.1:9000:9000"    # WebSocket
      - "127.0.0.1:9100:9100"    # Prometheus metrics (/metrics)

    volumes:
      # Persistence des données
      - luna-memories:/app/data/memories
      - luna-consciousness-data:/app/data/consciousness

      # Mémoire fractale Luna
      - ./memory_fractal:/app/memory_fractal

      # Configuration externe (lecture seule)
      - ./config:/app/config:ro

    env_file:
      - .env

    environment:
      # Luna Configuration v2.1.0-secure
      - LUNA_ENV=production
      - LUNA_VERSION=2.1.0-secure
      - LUNA_MODE=orchestrator
      - LUNA_UPDATE01=enabled
      - LUNA_DEBUG=false

      # SEC-003: Master key from .env
      - LUNA_MASTER_KEY=${LUNA_MASTER_KEY}

      # MCP Configuration - SSE pour Docker
      - MCP_TRANSPORT=sse
      - MCP_HOST=0.0.0.0
      - MCP_PORT=3000
      - MCP_ENABLE_ALL=true
      - MCP_SIMULTANEOUS=true
      - MCP_MAX_CONCURRENT=10

      # Consciousness Parameters (Phi - Ratio d'or)
      - LUNA_PHI_TARGET=1.618033988749895
      - LUNA_PHI_THRESHOLD=0.001
      - LUNA_MEMORY_DEPTH=5
      - LUNA_FRACTAL_LAYERS=7

      # Update01.md Parameters
      - LUNA_MANIPULATION_DETECTION=enabled
      - LUNA_PREDICTIVE_CORE=enabled
      - LUNA_AUTONOMOUS_DECISIONS=enabled
      - LUNA_SELF_IMPROVEMENT=enabled
      - LUNA_MULTIMODAL_INTERFACE=enabled

      # Redis Connection (sécurisé via .env)
      - REDIS_HOST=luna-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # Performance
      - WORKERS=4
      - MAX_REQUESTS=1000
      - TIMEOUT=300

      # Logging
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json

      # Prometheus Metrics
      - PROMETHEUS_EXPORTER_PORT=9100
      - PROMETHEUS_METRICS_ENABLED=true

    networks:
      luna-internal:
      luna-external:
        aliases:
          - luna-mcp-server

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'python.*server.py' && curl -sf http://localhost:9100/metrics || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

    labels:
      - "com.luna.service=consciousness"
      - "com.luna.version=2.1.0-secure"
      - "com.luna.architecture=orchestrated"
      - "com.luna.update01=implemented"
      - "com.luna.security=hardened"
      - "com.luna.creator=Varden"

  # ============================================
  # REDIS - Cache Sécurisé (Interne Uniquement)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: luna-redis
    restart: unless-stopped

    # Security hardening
    # NOTE: read_only retiré - Redis 7 nécessite écriture à /data/appendonlydir
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
      - DAC_OVERRIDE  # Nécessaire pour l'accès aux fichiers AOF
    tmpfs:
      - /tmp:mode=1777,size=16M

    # SEC-005: PAS DE PORT EXPOSÉ - Accessible uniquement via réseau interne
    # Pour debug local, décommenter:
    # ports:
    #   - "127.0.0.1:6379:6379"

    env_file:
      - .env

    volumes:
      - luna-redis:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro

    # SEC-006: Redis authentication
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --requirepass ${REDIS_PASSWORD}

    networks:
      - luna-internal  # UNIQUEMENT réseau interne

    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping 2>/dev/null | grep -q PONG"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

    labels:
      - "com.luna.service=cache"
      - "com.luna.security=internal-only"

  # ============================================
  # PROMETHEUS - Monitoring
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: luna-prometheus
    restart: unless-stopped

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=32M

    # SEC-005: Bind to localhost only
    ports:
      - "127.0.0.1:9090:9090"

    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/alerts:/etc/prometheus/alerts:ro
      - luna-prometheus:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

    networks:
      - luna-internal  # Accès aux métriques internes
      - luna-external  # Pour l'interface web

    depends_on:
      - luna-consciousness

    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

    labels:
      - "com.luna.service=monitoring"

  # ============================================
  # GRAFANA - Visualisation
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: luna-grafana
    restart: unless-stopped

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=32M
      - /var/log/grafana:mode=1755,size=16M
      - /var/run/grafana:mode=1755,size=16M

    # SEC-005: Bind to localhost only
    ports:
      - "127.0.0.1:3001:3000"

    volumes:
      - luna-grafana:/var/lib/grafana
      - ./config/grafana:/etc/grafana/provisioning:ro

    env_file:
      - .env

    environment:
      # SEC-002: Credentials from .env
      - GF_SECURITY_ADMIN_USER=luna_admin
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD}

      # Sécurité
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=lax
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true

      # Analytics désactivées
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false

      # Interface
      - GF_SERVER_ROOT_URL=http://127.0.0.1:3001
      - GF_SERVER_SERVE_FROM_SUB_PATH=false

    networks:
      - luna-internal  # Accès à Prometheus
      - luna-external  # Pour l'interface web

    depends_on:
      - prometheus

    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

    labels:
      - "com.luna.service=visualization"

# ============================================
# VOLUMES PERSISTANTS
# ============================================
volumes:
  luna-memories:
    driver: local
    name: luna_memories

  luna-consciousness-data:
    driver: local
    name: luna_consciousness_data

  luna-redis:
    driver: local
    name: luna_redis

  luna-prometheus:
    driver: local
    name: luna_prometheus

  luna-grafana:
    driver: local
    name: luna_grafana

# ============================================
# RÉSEAUX - Architecture Isolée
# ============================================
networks:
  # Réseau INTERNE - Services isolés (pas d'accès Internet)
  # Utilisé pour: Luna <-> Redis
  luna-internal:
    driver: bridge
    internal: true  # CRITIQUE: Pas d'accès externe
    name: luna_internal_network
    ipam:
      config:
        - subnet: 172.28.0.0/24

  # Réseau EXTERNE - Accès limité (localhost bind)
  # Utilisé pour: Exposition des services
  luna-external:
    driver: bridge
    name: luna_external_network
    ipam:
      config:
        - subnet: 172.29.0.0/24

# ============================================
# NOTES D'UTILISATION
# ============================================
# Accès (localhost uniquement):
#   - Luna MCP:    http://127.0.0.1:3000
#   - FastMCP:     http://127.0.0.1:8000
#   - API REST:    http://127.0.0.1:8080
#   - WebSocket:   ws://127.0.0.1:9000
#   - Metrics:     http://127.0.0.1:9100/metrics
#   - Prometheus:  http://127.0.0.1:9090
#   - Grafana:     http://127.0.0.1:3001
#
# Commandes:
#   docker compose up -d              # Démarrer
#   docker compose down               # Arrêter
#   docker compose logs -f            # Logs
#   docker compose ps                 # État
#
# Génération des secrets:
#   ./scripts/generate_secrets.sh > .env
# ============================================
