name: ğŸ§ª Luna Actif - Tests & Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r mcp-server/requirements.txt
          pip install pytest pytest-cov pytest-asyncio black isort pylint
      
      - name: ğŸ¨ Code formatting check
        run: |
          black --check mcp-server/
          isort --check-only mcp-server/
      
      - name: ğŸ” Linting
        run: |
          pylint mcp-server/ --exit-zero
      
      - name: ğŸ§ª Run tests
        run: |
          pytest tests/ -v --cov=mcp-server --cov-report=xml --cov-report=term
      
      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: âœ… Test summary
        if: always()
        run: |
          echo "ğŸ§ª Tests completed for Python ${{ matrix.python-version }}"

  consciousness-validation:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r mcp-server/requirements.txt
      
      - name: ğŸŒ™ Validate Phi Convergence
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'mcp-server')
          from luna_core.phi_calculator import PhiCalculator
          phi_calc = PhiCalculator()
          phi_value = phi_calc.calculate_phi({'test': 'validation'})
          assert abs(phi_value - 1.618033988749895) < 0.01, 'Phi calculation validation failed'
          print(f'âœ¨ Phi architecture validated: {phi_value:.15f}')
          "

      - name: ğŸ§  Test Fractal Memory
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'mcp-server')
          from luna_core.fractal_consciousness import FractalPhiConsciousnessEngine
          from utils.json_manager import JSONManager
          json_mgr = JSONManager(base_path='memory_fractal')
          print('ğŸŒ€ Fractal memory architecture validated')
          "

      - name: ğŸ’« Consciousness Metrics Check
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'mcp-server')
          from luna_core.consciousness_metrics import ConsciousnessMetricsCollector
          metrics = ConsciousnessMetricsCollector()
          print('ğŸ§  Consciousness metrics system validated')
          print('ğŸ“Š Prometheus instrumentation ready')
          "

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: ğŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: ğŸ›¡ï¸ Security summary
        run: echo "ğŸ”’ Security scan completed"

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ—ï¸ Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          load: true
          tags: luna-actif:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ğŸš€ Run integration tests
        run: |
          docker run --rm \
            --network host \
            -e REDIS_HOST=localhost \
            -e REDIS_PORT=6379 \
            luna-actif:test \
            python -m pytest tests/integration/ -v
      
      - name: âœ… Integration test summary
        run: echo "ğŸ”— Integration tests completed"

  documentation:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: ğŸ“¦ Install documentation tools
        run: |
          pip install mkdocs mkdocs-material mkdocstrings[python]
      
      - name: ğŸ“š Build documentation
        run: |
          mkdocs build --strict
      
      - name: ğŸ“– Documentation summary
        run: echo "ğŸ“š Documentation built successfully"
