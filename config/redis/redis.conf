# ============================================
# LUNA REDIS - Configuration Securisee
# ============================================
# Version: 2.1.0-secure
# Auteur: Varden & Luna
# ============================================

# ============================================
# RESEAU
# ============================================
# Bind sur toutes les interfaces Docker internes
# Redis n'est PAS expose sur l'hote (pas de port mapping)
bind 0.0.0.0

# Mode protege actif - requiert authentification
protected-mode yes

# Port standard Redis (interne au reseau Docker)
port 6379

# TCP keepalive pour connexions persistantes
tcp-keepalive 300

# Timeout de connexion (0 = pas de timeout)
timeout 0

# ============================================
# AUTHENTIFICATION
# ============================================
# Le mot de passe est injecte via la ligne de commande Docker
# avec --requirepass ${REDIS_PASSWORD}
# Cela permet d'utiliser les variables d'environnement

# ============================================
# PERSISTENCE
# ============================================
# Append-Only File pour durabilite des donnees
appendonly yes

# Synchronisation toutes les secondes (compromis perf/securite)
appendfsync everysec

# Repertoire des donnees
dir /data

# Nom du fichier AOF
appendfilename "appendonly.aof"

# RDB snapshots en complement
save 900 1
save 300 10
save 60 10000

# Nom du fichier RDB
dbfilename luna_redis_dump.rdb

# ============================================
# SECURITE - COMMANDES DANGEREUSES
# ============================================
# Desactiver completement les commandes destructrices
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command DEBUG ""

# Renommer CONFIG pour empecher modification a distance
rename-command CONFIG ""

# Renommer SHUTDOWN avec un nom secret
rename-command SHUTDOWN LUNA_SHUTDOWN_SECRET_CMD

# Desactiver les commandes de scripting (securite)
rename-command EVAL ""
rename-command EVALSHA ""
rename-command SCRIPT ""

# Desactiver les commandes cluster (non utilise)
rename-command CLUSTER ""
rename-command SLAVEOF ""
rename-command REPLICAOF ""

# ============================================
# LIMITES MEMOIRE
# ============================================
# Limite memoire maximale pour le cache Luna
maxmemory 256mb

# Politique d'eviction: supprime les cles les moins utilisees
maxmemory-policy allkeys-lru

# Echantillons pour l'algorithme LRU
maxmemory-samples 5

# ============================================
# LOGGING
# ============================================
# Niveau de log (debug, verbose, notice, warning)
loglevel notice

# Logs vers stdout (captures par Docker)
logfile ""

# ============================================
# PERFORMANCE
# ============================================
# Nombre de bases de donnees
databases 16

# Compression des strings si > 100 bytes
# (optimisation memoire pour les memoires fractales Luna)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# ============================================
# SLOW LOG (DEBUG)
# ============================================
# Enregistrer les commandes > 10ms
slowlog-log-slower-than 10000

# Garder les 128 dernieres entrees
slowlog-max-len 128

# ============================================
# NOTIFICATIONS (pour monitoring)
# ============================================
# Activer les notifications keyspace pour le monitoring
notify-keyspace-events "Ex"

# ============================================
# FIN DE CONFIGURATION
# ============================================
